<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Registration - HostelMate</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#eef2f9;overflow:auto}

/* FORM CARD */
.form-wrapper{display:flex;justify-content:center;padding:20px}
.form-card{
  width:80%;
  background:rgba(255,255,255,0.7);
  backdrop-filter:blur(14px);
  border-radius:30px;
  padding:36px 44px;
  box-shadow:0 30px 80px rgba(0,0,0,.25);
}

/* HEADER */
.header-row{display:flex;align-items:center;gap:14px;margin-bottom:26px}
.header-logo{width:52px;height:52px;border-radius:14px;overflow:hidden}
.header-logo img{width:100%;height:100%;object-fit:cover}
.form-title{font-family:'Playfair Display',serif;font-size:30px;color:#0d3a80}

/* GRID */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.field{margin-top:14px}
label{font-size:13px;margin-bottom:6px;display:block}

/* INPUTS + GLOW */
input,select{
  width:100%;height:50px;padding:0 14px;
  font-size:14px;border-radius:16px;
  border:1px solid #000;background:#fff;
  transition:.3s
}
input:hover,select:hover,
input:focus,select:focus{
  box-shadow:0 0 18px rgba(13,58,128,.45);
  transform:scale(1.02);
  outline:none;
}

/* IMAGE SECTION */
.image-section{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:30px}
.image-box{
  height:190px;border:2px dashed #0d3a80;
  border-radius:20px;display:flex;
  align-items:center;justify-content:center;
  flex-direction:column;cursor:pointer;
  position:relative;background:#fff;
  transition:.3s;
}
.image-box:hover{
  box-shadow:0 0 20px rgba(13,58,128,.5);
}
.image-box span{font-size:13px;color:#0d3a80;text-align:center}
.image-box img{width:100%;height:100%;object-fit:contain;display:none;position:absolute}
.image-box input{position:absolute;inset:0;opacity:0;cursor:pointer}

/* BUTTON */
.register-btn{
  margin-top:36px;width:100%;height:54px;
  font-size:17px;font-weight:bold;
  background:linear-gradient(135deg,#0d6efd,#003f9e);
  color:white;border:none;border-radius:20px;
  cursor:pointer;transition:.3s
}
.register-btn:hover{
  box-shadow:0 0 30px rgba(13,110,253,.7);
  transform:scale(1.04)
}

/* MODAL */
body.modal-open .form-card{filter:blur(6px);pointer-events:none}
#confirmationModal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;
  z-index:9999
}
.modal-content{
  background:#fff;padding:32px 40px;
  border-radius:20px;width:420px;
  text-align:center
}
.options{display:flex;gap:12px;margin-top:20px}
.options button{
  flex:1;padding:12px;border:none;
  border-radius:14px;background:#0d6efd;
  color:white;font-weight:bold;cursor:pointer;
  transition:.3s
}
.options button:hover{background:#003f9e}

.code-inputs{display:flex;justify-content:center;gap:12px;margin:22px 0}
.code-inputs input{
  width:52px;height:52px;
  text-align:center;font-size:22px;
  border:2px solid #0d3a80;border-radius:10px
}

.resend{
  font-size:14px;margin-top:10px;
}
.resend span{
  color:#0d3a80;cursor:pointer;font-weight:bold
}

/* SUCCESS */
.success-wrapper{display:none;flex-direction:column;align-items:center;gap:18px}
.circle-tick{
  width:100px;height:100px;border-radius:50%;
  border:4px solid #0d6efd;display:flex;
  align-items:center;justify-content:center
}
.tick{
  width:40px;height:20px;border-left:4px solid #0d6efd;
  border-bottom:4px solid #0d6efd;
  transform:rotate(-45deg)
}
.success-btn{
  padding:12px 22px;border:none;border-radius:16px;
  background:#0d6efd;color:white;
  cursor:pointer;font-weight:bold;
  transition:.3s
}
.success-btn:hover{
  background:#003f9e;
  box-shadow:0 0 15px #0d6efd;
}
</style>
</head>

<body>

<div class="form-wrapper">
<form class="form-card" id="adminForm">

  <div class="header-row">
    <div class="header-logo">
      <img src="https://i.ibb.co/LDWnBVWf/59e47443259fadca4151fd6273ac0ebd.jpg">
    </div>
    <div class="form-title">Admin Registration</div>
  </div>

  <div class="grid-2">
    <div class="field"><label>Full Name</label><input type="text" id="fullName" required></div>
    <div class="field"><label>Your Hostel Code</label><input type="text" id="hostelCode" required></div>
    <div class="field"><label>Official Email</label><input type="email" id="email" required></div>
    <div class="field"><label>Phone Number</label><input type="tel" id="phone" required></div>
    <div class="field"><label>CNIC / Staff ID</label><input type="text" id="cnicStaffId" required></div>
    <div class="field"><label>Password</label><input type="password" id="password" required></div>
    <div class="field"><label>Confirm Password</label><input type="password" id="confirmPassword" required></div>
  </div>

  <div class="image-section">
    <label class="image-box">
      <input type="file" id="adminPhoto" onchange="preview(this)" required>
      <span>Admin Photo</span><img>
    </label>
    <label class="image-box">
      <input type="file" id="idCard" onchange="preview(this)" required>
      <span>ID Card</span><img>
    </label>
    <label class="image-box">
      <input type="file" id="staffCard" onchange="preview(this)" required>
      <span>Staff Card</span><img>
    </label>
  </div>

  <button type="submit" class="register-btn">REGISTER ADMIN</button>
</form>
</div>

<!-- MODAL -->
<div id="confirmationModal">
  <div class="modal-content">

    <div id="step1">
      <h2>Where should we send your confirmation code?</h2>
      <div class="options">
        <button type="button" data-type="gmail">Via Gmail</button>
        <button type="button" data-type="message">Via Message</button>
      </div>
    </div>

    <div id="step2" style="display:none">
      <h2 id="sentText">Sending code...</h2>
      <div class="code-inputs">
        <input maxlength="1" required><input maxlength="1" required><input maxlength="1" required><input maxlength="1" required>
      </div>
      <div class="resend">
        Didn't receive code? <span id="resend">Send again</span>
      </div>
    </div>

    <div id="success" class="success-wrapper">
      <div class="circle-tick"><div class="tick"></div></div>
      <p>Admin verified successfully!</p>
      <button type="button" class="success-btn" onclick="goBack()">Back to Login</button>
    </div>

  </div>
</div>

<script type="module">
  // Import Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBAeUoj-jOOv1dHFf3r98K44GeGhJnE1T8",
    authDomain: "hostelmate-na2715.firebaseapp.com",
    projectId: "hostelmate-na2715",
    storageBucket: "hostelmate-na2715.firebasestorage.app",
    messagingSenderId: "322572880442",
    appId: "1:322572880442:web:87c7273991016f80e2c303",
    measurementId: "G-RFSWJL3ZDM"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Store form data globally
  let formData = {};

  // Image preview function
  window.preview = function(input){
    const img = input.nextElementSibling.nextElementSibling;
    const reader = new FileReader();
    reader.onload = e => {
      img.src = e.target.result;
      img.style.display = 'block';
      input.nextElementSibling.style.display = 'none';
    }
    reader.readAsDataURL(input.files[0]);
  }

  // Handle form submit
  document.getElementById('adminForm').addEventListener('submit', async function(e){
    e.preventDefault();

    // Check password match
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if(password !== confirmPassword){
      alert('Passwords do not match!');
      return;
    }

    // Validate file inputs
    const files = document.querySelectorAll('.image-box input');
    for(let f of files){
      if(f.files.length === 0){
        alert('Please upload all required files!');
        return;
      }
    }

    // Get Staff ID
    const staffId = document.getElementById('cnicStaffId').value.trim();

    // Check if Staff ID already exists
    try {
      const docRef = doc(db, "admins", staffId);
      const docSnap = await getDoc(docRef);
      
      if(docSnap.exists()){
        alert('This Staff ID is already registered!');
        return;
      }
    } catch (error) {
      console.error("Error checking Staff ID:", error);
    }

    // Collect form data
    formData = {
      fullName: document.getElementById('fullName').value,
      hostelCode: document.getElementById('hostelCode').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      cnicStaffId: staffId,
      password: password,
      registrationDate: new Date().toISOString(),
      status: 'pending',
      role: 'admin'
    };

    // Show modal
    document.getElementById('confirmationModal').style.display = 'flex';
    document.body.classList.add('modal-open');
  });

  // Modal step1 buttons
  document.querySelectorAll('.options button').forEach(btn => {
    btn.onclick = () => {
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';

      const text = document.getElementById('sentText');
      text.textContent = 'Sending code...';

      setTimeout(() => {
        text.textContent = 'Confirmation code has been sent!';
      }, 2000);
    };
  });

  document.getElementById('resend').onclick = () => {
    alert('Verification code sent again!');
  };

  // Code input logic with Firebase save using Staff ID as document ID
  const inputs = document.querySelectorAll('.code-inputs input');
  inputs.forEach((i, idx) => {
    i.oninput = async () => {
      if(i.value && idx < inputs.length - 1) inputs[idx + 1].focus();
      
      const code = [...inputs].map(x => x.value).join('');
      if(code === '1234'){
        try {
          // Use Staff ID as document ID
          const staffId = formData.cnicStaffId;
          
          // Save to Firebase in "admins" collection with Staff ID as document ID
          await setDoc(doc(db, "admins", staffId), formData);
          console.log("Admin registered successfully with Staff ID:", staffId);
          
          document.getElementById('step2').style.display = 'none';
          document.getElementById('success').style.display = 'flex';
        } catch (error) {
          console.error("Error adding admin: ", error);
          alert("Registration failed. Please try again.");
        }
      }
    };
  });

  window.goBack = function(){
    window.location.href = 'index.html';
  }
</script>

</body>
</html>